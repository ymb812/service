from ollama import AsyncClient
from settings.settings import settings
import json
import re
import logging

logger = logging.getLogger(__name__)


class OllamaService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Ollama —á–µ—Ä–µ–∑ AsyncClient"""

    def __init__(self):
        self.client = AsyncClient(host=settings.ollama_url)
        self.model = settings.ollama_model

    async def _generate(
            self,
            prompt: str,
            temperature: float = None,
            num_predict: int = None,
            stream: bool = False
    ) -> str:
        """–ë–∞–∑–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞"""
        options = {
            'temperature': temperature or settings.ollama_temperature,
            'num_predict': num_predict or settings.ollama_num_predict,
        }

        if stream:
            response = await self.client.generate(
                model=self.model,
                prompt=prompt,
                options=options,
                stream=True
            )

            full_text = ''
            async for chunk in response:
                full_text += chunk.get('response', '')

            return full_text
        else:
            response = await self.client.generate(
                model=self.model,
                prompt=prompt,
                options=options,
                stream=False
            )
            return response['response']

    def _extract_json(self, text: str) -> dict:
        """–£–º–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ JSON –∏–∑ —Ç–µ–∫—Å—Ç–∞ LLM"""
        # 1. –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ JSON –±–ª–æ–∫ –≤ markdown
        code_block = re.search(r'```json\s*(\{.*?\})\s*```', text, re.DOTALL)
        if code_block:
            text = code_block.group(1)

        # 2. –ü–æ–∏—Å–∫ –ø–µ—Ä–≤–æ–π { –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π }
        start = text.find('{')
        end = text.rfind('}')

        if start == -1 or end == -1:
            raise ValueError("No JSON found in response")

        json_str = text[start:end + 1]

        # 3. –ü–∞—Ä—Å–∏–Ω–≥ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–æ–π
        try:
            return json.loads(json_str)
        except json.JSONDecodeError as e:
            logger.error(f"JSON parse error at position {e.pos}:\n{json_str[max(0, e.pos - 50):e.pos + 50]}")
            raise ValueError(f"Invalid JSON: {e.msg}")

    async def check_profession_reality(self, user_message: str) -> dict:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        {
            "is_real": true/false,
            "profession_name": "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏" –∏–ª–∏ null,
            "alternatives": ["–ü—Ä–æ—Ñ–µ—Å—Å–∏—è 1", "–ü—Ä–æ—Ñ–µ—Å—Å–∏—è 2", "–ü—Ä–æ—Ñ–µ—Å—Å–∏—è 3"] –∏–ª–∏ null
        }
        """
        prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º –≤ –ª—é–±—ã—Ö —Å—Ñ–µ—Ä–∞—Ö –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª: "{user_message}"

–û–ø—Ä–µ–¥–µ–ª–∏:
1. –≠—Ç–æ —Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏—è? (–¥–∞/–Ω–µ—Ç)
2. –ï—Å–ª–∏ –¥–∞ - –∫–∞–∫ –æ–Ω–∞ —Ç–æ—á–Ω–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è?
3. –ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–µ–¥–ª–æ–∂–∏ 3 –ø–æ—Ö–æ–∂–∏–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏

–û—Ç–≤–µ—Ç—å –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
    "is_real": true,
    "profession_name": "–¢–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏",
    "alternatives": null
}}

–ò–õ–ò –µ—Å–ª–∏ –Ω–µ—Ä–µ–∞–ª—å–Ω–∞—è:
{{
    "is_real": false,
    "profession_name": null,
    "alternatives": ["–ü—Ä–æ—Ñ–µ—Å—Å–∏—è 1", "–ü—Ä–æ—Ñ–µ—Å—Å–∏—è 2", "–ü—Ä–æ—Ñ–µ—Å—Å–∏—è 3"]
}}

–û—Ç–≤–µ—Ç (—Ç–æ–ª—å–∫–æ JSON):"""

        response = await self._generate(
            prompt,
            temperature=0.3,
            num_predict=200,
            stream=False
        )

        return self._extract_json(response)

    async def generate_profession_detail_question(
            self,
            profession_name: str,
            question_number: int,
            initial_context: str = "",
            previous_qa: list = None
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ (–¥–æ 2 –≤–æ–ø—Ä–æ—Å–æ–≤)
        –§–æ–∫—É—Å: –ø–æ–Ω—è—Ç—å –û–©–£–©–ï–ù–ò–ï —Ä–∞–±–æ—Ç—ã, –∞ –Ω–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
        """
        context_parts = []

        if initial_context:
            context_parts.append(f"–ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å: '{initial_context}'")

        if previous_qa:
            qa_text = "\n".join([
                f"- –í–æ–ø—Ä–æ—Å: {qa['question']}\n  –û—Ç–≤–µ—Ç: {qa['answer']}"
                for qa in previous_qa if qa.get('answer')
            ])
            if qa_text:
                context_parts.append(f"–£–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ:\n{qa_text}")

        context_block = "\n\n".join(context_parts) if context_parts else "–ö–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."

        prompt = f"""–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å —Å—Ç—É–¥–µ–Ω—Ç–∞–º –∏ –Ω–∞—á–∏–Ω–∞—é—â–∏–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º –ø–æ–Ω—è—Ç—å, –∫–∞–∫ "–æ—â—É—â–∞–µ—Ç—Å—è" —Ä–∞–±–æ—Ç–∞ –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ "{profession_name}".

    {context_block}

    –≠—Ç–æ –≤–æ–ø—Ä–æ—Å #{question_number} –∏–∑ –º–∞–∫—Å–∏–º—É–º 2.

    –í–ê–ñ–ù–û: –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ø–æ–Ω—è—Ç—å –ê–¢–ú–û–°–§–ï–†–£ –∏ –ë–£–î–ù–ò, –∞ –Ω–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏.

    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ (–∑–∞–¥–∞–≤–∞–π –¢–û, —á—Ç–æ –µ—â—ë –ù–ï –≤—ã—è—Å–Ω–µ–Ω–æ):
    1. –†–∞–∑–º–µ—Ä –∏ —Ç–∏–ø –∫–æ–º–ø–∞–Ω–∏–∏ (—ç—Ç–æ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ –º–µ–Ω—è–µ—Ç –æ—â—É—â–µ–Ω–∏—è):
       - –°—Ç–∞—Ä—Ç–∞–ø
       - –ü—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è
       - –ö–æ—Ä–ø–æ—Ä–∞—Ü–∏—è
       - –§—Ä–∏–ª–∞–Ω—Å

    2. –£—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —è—Å–µ–Ω):
       - –ë–µ–∑ –æ–ø—ã—Ç–∞
       - –°—Ä–µ–¥–Ω–∏–π
       - –°—Ç–∞—Ä—à–∏–π

    –ó–ê–ü–†–ï–©–ï–ù–û —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å:
    - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ (—è–∑—ã–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã ‚Äî —ç—Ç–æ —É–∑–Ω–∞–µ—à—å –ø–æ–∑–∂–µ)
    - –°–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–æ–≤–∏—á–æ–∫ –Ω–µ –ø–æ–π–º—ë—Ç
    - –í–æ–ø—Ä–æ—Å—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ

    –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: –û–î–ò–ù –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å (–¥–æ 15 —Å–ª–æ–≤) —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–∞ –≤ —Å–∫–æ–±–∫–∞—Ö.

    –ü—Ä–∏–º–µ—Ä—ã –•–û–†–û–®–ò–• –≤–æ–ø—Ä–æ—Å–æ–≤:
    - "–í –∫–∞–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å? (–°—Ç–∞—Ä—Ç–∞–ø / –ü—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è / –ö–æ—Ä–ø–æ—Ä–∞—Ü–∏—è / –§—Ä–∏–ª–∞–Ω—Å)"
    - "–ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? (Junior / Middle / Senior / Team Lead)"
    - "–ö–∞–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–ª–∏–∂–µ? (–ü—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ / –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞—è / –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è)"

    –¢–≤–æ–π –≤–æ–ø—Ä–æ—Å:"""

        response = await self._generate(
            prompt,
            temperature=0.1,
            num_predict=200,
            stream=False
        )
        return response.strip().strip('"\'')

    async def generate_vibe_question(self, profession_context: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø—Ä–æ "–≤–∞–π–±" —Ä–∞–±–æ—Ç—ã
        """
        prompt = f"""–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏: "{profession_context}"

–ó–∞–¥–∞–π –û–î–ò–ù –≤–æ–ø—Ä–æ—Å (–¥–æ 15 —Å–ª–æ–≤) –ø—Ä–æ –æ–±—â—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –∏ —Å—Ç–∏–ª—å —Ä–∞–±–æ—Ç—ã - –Ω—É–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å –ø–æ–∂–µ–ª–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:
- "–ë–æ–ª—å—à–µ –∫—Ä–µ–∞—Ç–∏–≤–∞ –∏–ª–∏ —Ä—É—Ç–∏–Ω—ã?"
- "–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–π —Ç–µ–º–ø –∏–ª–∏ —Ä–∞–∑–º–µ—Ä–µ–Ω–Ω—ã–π?"
- "–†–∞–±–æ—Ç–∞ –≤ –æ–¥–∏–Ω–æ—á–∫—É –∏–ª–∏ –≤ –∫–æ–º–∞–Ω–¥–µ?"
- "–ì–ª—É–±–æ–∫–æ–µ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ –∏–ª–∏ —à–∏—Ä–æ–∫–∏–π –æ—Ö–≤–∞—Ç?"
- "–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏–ª–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è?"
- "–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º –∏–ª–∏ —Å–≤–æ–±–æ–¥–∞ –¥–µ–π—Å—Ç–≤–∏–π?"

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç–æ–º –≤–æ–ø—Ä–æ—Å–∞ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫."""

        response = await self._generate(
            prompt,
            temperature=0.3,
            num_predict=50,
            stream=False
        )
        return response.strip().strip('"\'')

    async def generate_profile(
            self,
            profession_name: str,
            clarification_history: list,
            vibe_answer: str,
            progress_callback=None
    ) -> dict:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—å–µ—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –û–©–£–©–ï–ù–ò–ï —Ä–∞–±–æ—Ç—ã
        """
        context_parts = [f"Q: {item['question']}\nA: {item['answer']}"
                         for item in clarification_history]
        context = "\n\n".join(context_parts)

        prompt = f"""–¢—ã —Å–æ–∑–¥–∞—ë—à—å –ñ–ò–í–û–ï –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤.

    –¢–≤–æ—è —Ü–µ–ª—å: –ø–µ—Ä–µ–¥–∞—Ç—å **–û–©–£–©–ï–ù–ò–ï** —Ä–∞–±–æ—Ç—ã, –∞ –Ω–µ —Å—É—Ö–∏–µ —Ñ–∞–∫—Ç—ã –∏–∑ –¥–æ–ª–∂–Ω–æ—Å—Ç–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.

    –ü—Ä–æ—Ñ–µ—Å—Å–∏—è: "{profession_name}"

    –ö–æ–Ω—Ç–µ–∫—Å—Ç:
    {context}

    –û–±—â–∏–π –≤–∞–π–±: "{vibe_answer}"

    ---

    –°–æ–∑–¥–∞–π –ø—Ä–æ—Ñ–∏–ª—å –≤ JSON:

    {{
        "position_title": "–ù–∞–∑–≤–∞–Ω–∏–µ + –∫–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: 'Junior Frontend-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –≤ —Å—Ç–∞—Ä—Ç–∞–ø–µ —Ñ–∏–Ω—Ç–µ—Ö–∞')",

        "sounds": [
            "–ó–≤—É–∫ 1 (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–¢—Ä–µ—Å–∫ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤ open space')",
            "–ó–≤—É–∫ 2 (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–ü–∏–Ω–≥–∏ –≤ Slack –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç')",
            "–ó–≤—É–∫ 3 (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–ì–æ–ª–æ—Å PM: –ê –º–æ–∂–Ω–æ –µ—â—ë –æ–¥–Ω—É —Ñ–∏—á—É –¥–æ —Ä–µ–ª–∏–∑–∞?')"
        ],

        "career_growth": "–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –ø—É—Ç—å —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Ä–∞–º–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 'Junior (0-2 –≥–æ–¥–∞) ‚Üí Middle (2-4 –≥–æ–¥–∞) ‚Üí Senior (4-6 –ª–µ—Ç) ‚Üí Team Lead (6+ –ª–µ—Ç)')",

        "balance_score": "XX/YY (–≥–¥–µ X ‚Äî —Ä–∞–±–æ—Ç–∞, Y ‚Äî –ª–∏—á–Ω–∞—è –∂–∏–∑–Ω—å)",

        "benefit": "–ì–ª–∞–≤–Ω–∞—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã. –ù–µ '–≤—ã—Å–æ–∫–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞', –∞ –ß–¢–û –¥–∞—ë—Ç –∫–∞–π—Ñ: '–¢—ã —Å–æ–∑–¥–∞—ë—à—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∫–æ—Ç–æ—Ä—ã–º –ø–æ–ª—å–∑—É—é—Ç—Å—è –º–∏–ª–ª–∏–æ–Ω—ã –ª—é–¥–µ–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å'",

        "typical_day": "–î–ï–¢–ê–õ–¨–ù–û–ï –æ–ø–∏—Å–∞–Ω–∏–µ –¥–Ω—è –æ—Ç –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è –¥–æ —Å–Ω–∞. –ú–∏–Ω–∏–º—É–º 7-10 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –ü—Ä–∏–º–µ—Ä:

        '–ü—Ä–æ—Å—ã–ø–∞–µ—à—å—Å—è –≤ 9:00, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–µ–¥–ª–∞–π–Ω–æ–≤ –Ω–µ—Ç ‚Äî —Å–ø—Ä–∏–Ω—Ç —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª—Å—è. –í–∫–ª—é—á–∞–µ—à—å –Ω–æ—É—Ç–±—É–∫, –∑–∞—Ö–æ–¥–∏—à—å –≤ Figma ‚Äî –¥–∏–∑–∞–π–Ω–µ—Ä –æ–±–Ω–æ–≤–∏–ª –º–∞–∫–µ—Ç—ã –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –û—Ç–∫—Ä—ã–≤–∞–µ—à—å VS Code, –∑–∞–ø—É—Å–∫–∞–µ—à—å dev-—Å–µ—Ä–≤–µ—Ä, –ø—å—ë—à—å –∫–æ—Ñ–µ. –í 10:00 –¥–µ–π–ª–∏: PM –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å UX —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –¢—ã –∑–∞–∫–∞—Ç—ã–≤–∞–µ—à—å –≥–ª–∞–∑–∞, –Ω–æ –ø–æ–Ω–∏–º–∞–µ—à—å ‚Äî —Ç–∞–∫ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞—Ä—Ç–∞–ø. –î–æ –æ–±–µ–¥–∞ –∫–æ–¥–∏—à—å –Ω–æ–≤—É—é —Ñ–æ—Ä–º—É, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≥—É–≥–ª–∏—à—å, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å email –≤ React Hook Form. –ü–æ—Å–ª–µ –æ–±–µ–¥–∞ ‚Äî –∫–æ–¥-—Ä–µ–≤—å—é –æ—Ç —Å–µ–Ω—å–æ—Ä–∞: 15 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ò—Å–ø—Ä–∞–≤–ª—è–µ—à—å, —É—á–∏—à—å—Å—è. –í 17:00 ‚Äî —Å–æ–∑–≤–æ–Ω —Å –±—ç–∫–µ–Ω–¥–µ—Ä–æ–º: API —Å–Ω–æ–≤–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ —Ç–µ –¥–∞–Ω–Ω—ã–µ. –î–µ–±–∞–∂–∏—Ç–µ –≤–º–µ—Å—Ç–µ. –í 18:30 –ø—É—à–∏—à—å –∫–æ–¥, —Å–æ–∑–¥–∞—ë—à—å PR. –í 19:00 –∑–∞–∫—Ä—ã–≤–∞–µ—à—å –Ω–æ—É—Ç–±—É–∫, –∏–¥—ë—à—å –≥—É–ª—è—Ç—å ‚Äî –∑–∞–≤—Ç—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—à—å.'",

        "real_cases": [
            {{
                "title": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∑–∞–¥–∞—á–∞ (–Ω–µ '—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏—á–∏', –∞ '–°–¥–µ–ª–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –º–æ–±–∏–ª–æ–∫')",
                "description": "–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: –ß–¢–û –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, –ö–ê–ö–ò–ï —Å–ª–æ–∂–Ω–æ—Å—Ç–∏, –ß–¢–û –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫",
                "difficulty": "easy"
            }},
            {{
                "title": "...",
                "description": "...",
                "difficulty": "medium"
            }},
            {{
                "title": "...",
                "description": "...",
                "difficulty": "hard"
            }}
        ],

        "tech_stack": [
            "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç 1 (—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º: –Ω–µ –ø—Ä–æ—Å—Ç–æ 'React', –∞ 'React ‚Äî –ø–∏—à–µ—à—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ 8 —á–∞—Å–æ–≤ –≤ –¥–µ–Ω—å')",
            "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç 2",
            "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç 3",
            "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç 4"
        ],

        "visual": [
            "WHAT will you see in front of you (for example: 'Code in an application or building materials')",
            "WHAT will you see around you (for example: 'An office or a street')",
            "WHAT will you see as a result (for example: 'A completed task')"
        ],

        "chat_examples": [
            {{
                "colleague": "–ò–º—è –∫–æ–ª–ª–µ–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–°–∞—à–∞ (Backend-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫)')",
                "request": "–ö–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ-–∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–≠–π, –∞ –º–æ–∂–µ—à—å –≥–ª—è–Ω—É—Ç—å, –ø–æ—á–µ–º—É –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Safari?')",
                "your_response": "–¢–≤–æ–π –æ—Ç–≤–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–°–µ–π—á–∞—Å –ø—Ä–æ–≤–µ—Ä—é —á–µ—Ä–µ–∑ BrowserStack. Safari –æ–ø—è—Ç—å —á—Ç–æ-—Ç–æ —Å–æ —Å–≤–æ–∏–º–∏ —Å—Ç–∞—Ä—ã–º–∏ –ø–æ–ª–∏—Ñ–∏–ª–ª–∞–º–∏ ü§¶')",
                "vibe": "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ–∫—Ä–∞—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–û–±—ã—á–Ω–∞—è —Ä—É—Ç–∏–Ω–∞, –Ω–æ –ø—Ä–∏—è—Ç–Ω–æ –ø–æ–º–æ–≥–∞—Ç—å')"
            }},
            {{
                "colleague": "...",
                "request": "...",
                "your_response": "...",
                "vibe": "..."
            }},
            {{
                "colleague": "...",
                "request": "...",
                "your_response": "...",
                "vibe": "..."
            }},
            {{
                "colleague": "...",
                "request": "...",
                "your_response": "...",
                "vibe": "..."
            }},
            {{
                "colleague": "...",
                "request": "...",
                "your_response": "...",
                "vibe": "..."
            }}
        ]
    }}

    ---

    –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:

    1. **sounds** ‚Äî —ç—Ç–æ –ù–ï –º–µ—Ç–∞—Ñ–æ—Ä—ã, –∞ –†–ï–ê–õ–¨–ù–´–ï –∑–≤—É–∫–∏ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è:
       - –ü–ª–æ—Ö–æ: "–ó–≤—É–∫ —É—Å–ø–µ—Ö–∞" ‚ùå
       - –•–æ—Ä–æ—à–æ: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ 'Build failed' –≤ CI/CD" ‚úÖ

    2. **typical_day** ‚Äî —ç—Ç–æ –ò–°–¢–û–†–ò–Ø, –∞ –Ω–µ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á:
       - –ü–ª–æ—Ö–æ: "–£—Ç—Ä–æ–º –ø—Ä–æ–≤–µ—Ä—è—é –ø–æ—á—Ç—É, –ø–æ—Ç–æ–º –ø–∏—à—É –∫–æ–¥" ‚ùå
       - –•–æ—Ä–æ—à–æ: "–í 9:30 –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å Jira ‚Äî —Ç–∞–º 23 –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –ü–µ—Ä–≤—ã–º –¥–µ–ª–æ–º –ø—Ä–æ–≤–µ—Ä—è–µ—à—å, –Ω–µ —Å–ª–æ–º–∞–ª—Å—è –ª–∏ –ø—Ä–æ–¥ –Ω–æ—á—å—é..." ‚úÖ

    3. **real_cases** ‚Äî –ö–û–ù–ö–†–ï–¢–ù–´–ï –∑–∞–¥–∞—á–∏ —Å –†–ï–ê–õ–¨–ù–´–ú–ò —Å–ª–æ–∂–Ω–æ—Å—Ç—è–º–∏:
       - –ü–ª–æ—Ö–æ: "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏" ‚ùå
       - –•–æ—Ä–æ—à–æ: "–°–¥–µ–ª–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Å–∫—Ä–æ–ª–ª –Ω–∞ React, –Ω–æ —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–µ –ª–∞–≥–∞–ª–æ –Ω–∞ —Å—Ç–∞—Ä—ã—Ö iPhone. ‚úÖ

    4. **benefit** ‚Äî –≠–ú–û–¶–ò–Ø, –∞ –Ω–µ —Ñ–∞–∫—Ç:
       - –ü–ª–æ—Ö–æ: "–•–æ—Ä–æ—à–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞" ‚ùå
       - –•–æ—Ä–æ—à–æ: "–í 2 —á–∞—Å–∞ –Ω–æ—á–∏ –ø—Ä–æ—Å—ã–ø–∞–µ—à—å—Å—è –æ—Ç –º—ã—Å–ª–∏, –∫–∞–∫ –∫—Ä–∞—Å–∏–≤–æ —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É ‚Äî –∏ —ç—Ç–æ –∫–∞–π—Ñ" ‚úÖ

    5. **visual** ‚Äî –æ–ø–∏—Å—ã–≤–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã —á–µ–ª–æ–≤–µ–∫ –º–æ–≥ –ü–†–ï–î–°–¢–ê–í–ò–¢–¨ –∫–∞—Ä—Ç–∏–Ω–∫—É:
       - –ü–ª–æ—Ö–æ: "–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ" ‚ùå
       - –•–æ—Ä–æ—à–æ: "MacBook Pro —Å –Ω–∞–∫–ª–µ–π–∫–∞–º–∏, –≤—Ç–æ—Ä–æ–π –º–æ–Ω–∏—Ç–æ—Ä 27', —Å—Ç–æ–ª —É –æ–∫–Ω–∞ —Å –≤–∏–¥–æ–º –Ω–∞ –≥–æ—Ä–æ–¥" ‚úÖ

    6. **chat_examples** ‚Äî –†–ï–ê–õ–¨–ù–´–ï –¥–∏–∞–ª–æ–≥–∏ –∏–∑ —Ä–∞–±–æ—á–∏—Ö —á–∞—Ç–æ–≤ (Slack, Telegram, Teams):
       - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 2 –ø—Ä–∏–º–µ—Ä–∞
       - –ü–æ–∫–∞–∂–∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å–∏—Ç—É–∞—Ü–∏–π: —Å—Ä–æ—á–Ω—ã–π –±–∞–≥, –æ–±—ã—á–Ω–∞—è –∑–∞–¥–∞—á–∞, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è, –ø–æ–º–æ—â—å –∫–æ–ª–ª–µ–≥–µ, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
       - –ò—Å–ø–æ–ª—å–∑—É–π –∂–∏–≤–æ–π —è–∑—ã–∫
       - –ü—Ä–∏–º–µ—Ä—ã:

         **–ü–ª–æ—Ö–æ:**
         - –ö–æ–ª–ª–µ–≥–∞: "–ü–æ–º–æ–≥–∏ —Å –∑–∞–¥–∞—á–µ–π"
         - –¢—ã: "–•–æ—Ä–æ—à–æ, –ø–æ–º–æ–≥—É" ‚ùå

         **–•–æ—Ä–æ—à–æ:**
         - **–ú–∞—à–∞ (QA):** "–ü—Ä–∏–≤–µ—Ç! –£ —Ç–µ–±—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è –∫–Ω–æ–ø–∫–∞ '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' –Ω–µ –∫–ª–∏–∫–∞–µ—Ç—Å—è –Ω–∞ iPhone 12"
         - **–¢—ã:** "–û–≥–æ, —Å–µ–π—á–∞—Å –≥–ª—è–Ω—É. –ê –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ —á—Ç–æ-—Ç–æ –µ—Å—Ç—å? –ú–æ–∂–µ—à—å —Å–∫—Ä–∏–Ω –∫–∏–Ω—É—Ç—å?"
         - **–í–∞–π–±:** "–û–±—ã—á–Ω—ã–π –±–∞–≥-—Ä–µ–ø–æ—Ä—Ç, –Ω–æ –ø—Ä–∏—è—Ç–Ω–æ, —á—Ç–æ QA —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç —Ç—â–∞—Ç–µ–ª—å–Ω–æ" ‚úÖ

    –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –±–µ–∑ markdown –±–ª–æ–∫–æ–≤ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π."""

        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–º –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
        if progress_callback:
            response = await self.client.generate(
                model=self.model,
                prompt=prompt,
                options={
                    'temperature': 0.3,
                    'num_predict': 3072
                },
                stream=True
            )

            full_text = ''
            import time
            last_update = time.time()
            update_interval = 1.0

            async for chunk in response:
                new_text = chunk.get('response', '')
                full_text += new_text

                current_time = time.time()
                if current_time - last_update >= update_interval:
                    await progress_callback(full_text)
                    last_update = current_time
        else:
            full_text = await self._generate(
                prompt,
                temperature=0.3,
                num_predict=3072,
                stream=False
            )

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º JSON
        data = self._extract_json(full_text)

        # –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        required_fields = [
            'position_title', 'sounds', 'career_growth', 'balance_score',
            'benefit', 'typical_day', 'real_cases', 'tech_stack', 'visual'
        ]

        for field in required_fields:
            if field not in data:
                raise ValueError(f"Missing required field: {field}")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç balance_score
        if not re.match(r'^\d+/\d+$', data['balance_score']):
            logger.warning(f"Invalid balance_score format: {data['balance_score']}, fixing to 50/50")
            data['balance_score'] = "50/50"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º real_cases
        if len(data['real_cases']) < 3:
            raise ValueError(f"Need at least 3 real_cases, got {len(data['real_cases'])}")

        for case in data['real_cases']:
            if 'title' not in case or 'description' not in case or 'difficulty' not in case:
                raise ValueError("Invalid real_case structure")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º chat_examples
        if len(data['chat_examples']) < 5:
            raise ValueError(f"Need at least 5 chat_examples, got {len(data['chat_examples'])}")

        for example in data['chat_examples']:
            required_chat_fields = ['colleague', 'request', 'your_response', 'vibe']
            for field in required_chat_fields:
                if field not in example:
                    raise ValueError(f"Invalid chat_example structure: missing '{field}'")

        return data

    async def close(self):
        """–ó–∞–∫—Ä—ã—Ç–∏–µ –∫–ª–∏–µ–Ω—Ç–∞"""
        pass


# Singleton instance
llm_service = OllamaService()
